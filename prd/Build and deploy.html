

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Build and Deploy &mdash; City Pooling 1.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="scoring_funcs module documentation" href="apidoc-build/solver.scoring_funcs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> City Pooling
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="City Pooling.html">City Pooling Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="apidoc-build/mods.html">Packages documentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build and Deploy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-steps-lint-test-and-make-documentation">Build steps: lint, test and make documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linting-running-flake8">Linting: running Flake8</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-testing-running-pytest">Unit testing: running Pytest</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-the-docs-running-sphinx">Making the docs: running Sphinx</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#automatic-documentation-from-python-modules-sphinx-apidoc">Automatic documentation from python modules: sphinx-apidoc</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-of-html-files-sphinx-build-make-html">Build of html files: sphinx-build (make html)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-steps-duplicate-docs-to-prd-and-push">Deploy steps: duplicate docs to prd/ and push</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#duplicate-built-docs-to-prd-folder">Duplicate built docs to <cite>prd/</cite> folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="#push-prd-folder-to-github">Push <cite>prd/</cite> folder to GitHub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#automating-these-steps">Automating these steps</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">City Pooling</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Build and Deploy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Build and deploy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="build-and-deploy">
<h1>Build and Deploy<a class="headerlink" href="#build-and-deploy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This project does not consist in an application that is avalaible for end users,
but rather the GitHub pages in which its presentation is stored:</p>
<ul class="simple">
<li><p>The aim of the Deploy step is to push the new version of the documentation online.</p></li>
<li><p>The aim of the Build step is to check that everything is ok and produce the new
version of the documentation.</p></li>
</ul>
<p>The folder structure of this project is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>City pooling
├── index.html                  # Redirects towards prd/index.html (see below)
|                               # It is the &quot;entry point&quot; of GitHub pages
|
├── src                         # src is where source code for packages is
│   ├── geography
│   │   ├── __init__.py
│   │   └── geography.py
│   ├── solver
│   │   ├── __init__.py
│   │   └── ...
│   └── ...
│
├── test                        # tests are outside the src directory
│   ├── test_geography.py       # run by pytest
│   └── ...
│
├── docs                        # all Sphinx files are in docs/, source
│   │                           # files as build artefacts
│   ├── source                  # where source files for docs are stored
│   │   ├── index.rst           # Main toctree source
│   │   ├── Build and deploy.rst# Other rst sources
│   │   ├── City Pooling.ipynb  # Jupyter Notebook sources
│   │   ├── apidoc-build        # Result of sphinx-apidoc build
│   │   │   ├── mods.rst        # Are built before sphinx-build
│   │   │   ├── geography.rst
│   │   │   ├── solver.rst
│   │   │   └── ...
│   │   └── ...
│   └── build                   # result of Sphinx build (staged here for
│       ├── index.html          # checking before shipping to production)
│       │                       # not sent to GitHub repo (build artefacts)
│       ├── Build and deploy.html
│       ├── apidoc-build
│       │   ├── mods.html
│       │   ├── geography.html
│       │   ├── solver.html
│       │   └── ...
│       └── ...
│
└── prd                         # &quot;Production&quot; folder, which is what can be
    │                           # seen in GitHub pages
    │                           # sent to GitHub repo. Is a copy of
    │                           # docs/build/ after successful checking
    ├── index.html
    ├── geography.html
    ├── Build and deploy.html
    ├── apidoc-build
    │   ├── mods.html
    │   ├── geography.html
    │   ├── solver.html
    │   └── ...
    └── ...
</pre></div>
</div>
<p>Documentation is deployed when <cite>prd/</cite> folder is updated from docs/build/ and
pushed to distant repo.</p>
</div>
<hr class="docutils" />
<div class="section" id="build-steps-lint-test-and-make-documentation">
<h2>Build steps: lint, test and make documentation<a class="headerlink" href="#build-steps-lint-test-and-make-documentation" title="Permalink to this headline">¶</a></h2>
<p>As the project is exclusively written in Python, no build per se is necessary for
the code part. However, as it is good practice, some checks are mandatory before
actually build the new version of the docs.</p>
<p>The real Build is when the Sphinx documentation is produced from .rst files,
Jupyter Notebook and .py files.</p>
<div class="section" id="linting-running-flake8">
<h3>Linting: running Flake8<a class="headerlink" href="#linting-running-flake8" title="Permalink to this headline">¶</a></h3>
<p>The linter used on this project is <a class="reference external" href="http://flake8.pycqa.org/en/latest/">Flake8</a>.</p>
<p>The command to run it a simple one. Just open a command prompt, navigate
to project folder root and run:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Linting: running flake8</span>
<span class="k">echo</span>.
<span class="k">echo</span> Running flake8. Error count:
flake8 --count
</pre></div>
</div>
<p>No warning or error should arise, a single <cite>0</cite> should be printed out.</p>
</div>
<div class="section" id="unit-testing-running-pytest">
<h3>Unit testing: running Pytest<a class="headerlink" href="#unit-testing-running-pytest" title="Permalink to this headline">¶</a></h3>
<p>Tests have to be written and run prior to any deployment to production. The
package used on this project is <a class="reference external" href="https://docs.pytest.org/en/latest/">Pytest</a>.</p>
<p>There is a small hack I had to come to to make it work.</p>
<p>As the modules to be tested are in the <cite>src</cite> folder, the beginning of the
test files looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Unit tests for the geography package</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">src.geography</span> <span class="k">import</span> <span class="n">geography</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Simply running pytest in the root directory would result in a
‘ModuleNotFoundError’ as <cite>src</cite> is not in the Python path.</p>
<a class="reference internal image-reference" href="_images/ModuleNotFound_pytest_error.png"><img alt="a pytest module not found exception error message" class="align-center" src="_images/ModuleNotFound_pytest_error.png" style="width: 100.0%; height: 426.0px;" /></a>
<p>One way to work around this problem is to
simply use the following command line from the project root directory:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Testing: running pytest</span>
<span class="k">echo</span>.
<span class="k">echo</span> Running pytest...
<span class="k">echo</span>.
python -m pytest --cov=src --cov-report term-missing
</pre></div>
</div>
<p>The <cite>-m</cite> option adds the current to the Python path, and during test discovery
pytest is then able to import sources packages.</p>
<a class="reference internal image-reference" href="_images/pytest_success_msg.png"><img alt="a pytest success message" class="align-center" src="_images/pytest_success_msg.png" style="width: 100.0%; height: 316.0px;" /></a>
</div>
<div class="section" id="making-the-docs-running-sphinx">
<h3>Making the docs: running Sphinx<a class="headerlink" href="#making-the-docs-running-sphinx" title="Permalink to this headline">¶</a></h3>
<div class="section" id="automatic-documentation-from-python-modules-sphinx-apidoc">
<h4>Automatic documentation from python modules: sphinx-apidoc<a class="headerlink" href="#automatic-documentation-from-python-modules-sphinx-apidoc" title="Permalink to this headline">¶</a></h4>
<p>The docstrings from python modules are preprocessed by the <a class="reference external" href="https://www.sphinx-doc.org/en/master/man/sphinx-apidoc.html">Sphinx apidoc</a> utility,
which discovers the packages of the project and then creates .rst files from
their docstrings.</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Building the docs: creating .rst files with apidoc</span>
<span class="k">echo</span>.
<span class="k">echo</span> Running Sphinx apidoc...
<span class="k">echo</span>.
<span class="k">rd</span> /s /q .\docs\source\apidoc-build
sphinx-apidoc -o .\docs\source\apidoc-build\ .\src\ -d 1 --force<span class="se">^</span>
<span class="se">-</span>-module-first --separate --no-headings --tocfile mods
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To avoid keeping outdated .rst files in the docs/source/apidoc-build
folder, this folder is deleted before running the <cite>sphinx-apidoc</cite> command.</p>
</div>
</div>
<div class="section" id="build-of-html-files-sphinx-build-make-html">
<h4>Build of html files: sphinx-build (make html)<a class="headerlink" href="#build-of-html-files-sphinx-build-make-html" title="Permalink to this headline">¶</a></h4>
<p>Sphinx comes in with a handy <cite>make.bat</cite> file which enables to smoothly build
all the documentation for the project.</p>
<p>It can be run by simply using the <cite>make html</cite> command, from the <cite>docs</cite> folder:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Building the docs: running Sphinx</span>
<span class="k">echo</span>.
<span class="k">echo</span> Running Sphinx
<span class="k">echo</span>.
docs\make html
</pre></div>
</div>
<p>It should run without showing errors, like this nice output:</p>
<a class="reference internal image-reference" href="_images/sphinx_build_success.png"><img alt="a Sphinx build success message" class="align-center" src="_images/sphinx_build_success.png" style="width: 100.0%; height: 328.0px;" /></a>
<p>After this step, a new version of the documentation is avalaible in the
<cite>docs/build</cite> folder.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Building the docs has no effect on the avalaible content on GitHub pages.
Deploy step is required.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Built documentation should always be checked prior to being deployed.</p>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="deploy-steps-duplicate-docs-to-prd-and-push">
<h2>Deploy steps: duplicate docs to prd/ and push<a class="headerlink" href="#deploy-steps-duplicate-docs-to-prd-and-push" title="Permalink to this headline">¶</a></h2>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Git Working tree should be clean before deploying, as any staged change
will be discarded upon deployment.</p>
</div>
<div class="section" id="duplicate-built-docs-to-prd-folder">
<h3>Duplicate built docs to <cite>prd/</cite> folder<a class="headerlink" href="#duplicate-built-docs-to-prd-folder" title="Permalink to this headline">¶</a></h3>
<p>First step is to duplicate the whole content of <cite>docs/build/</cite> folder to <cite>prd/</cite>
folder. This is done by simply using the <cite>robocopy</cite> tool from Windows after
having deleted the <cite>prd/</cite> folder content:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="k">echo</span> Replacing prd/ folder content
<span class="k">echo</span>.

<span class="c1">REM Delete prd\ folder and content</span>
<span class="k">rd</span> /s /q .\prd\

<span class="c1">REM Copy the content of docs\build\ to a brand new prd\ folder</span>
robocopy .\docs\build\ .\prd\ /E
</pre></div>
</div>
</div>
<div class="section" id="push-prd-folder-to-github">
<h3>Push <cite>prd/</cite> folder to GitHub<a class="headerlink" href="#push-prd-folder-to-github" title="Permalink to this headline">¶</a></h3>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>To avoid unintentionnaly commiting local changes when deploying, the first
step of deploying is to discard them.</p>
</div>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Unstage all changes</span>
<span class="k">echo</span>.
<span class="k">echo</span> Unstaging all changes
<span class="k">echo</span>.
git reset
</pre></div>
</div>
<p>The <cite>prd/</cite> folder has been added to the root <cite>.gitignore</cite> file of this project
so as to avoid unintentionnaly deploying to production unchecked docs.</p>
<p>Therefore, to add the <cite>prd/</cite> folder to the Git index, the following commands
are used:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span><span class="c1">REM Force adding of prd\ folder to git index</span>
<span class="k">echo</span>.
<span class="k">echo</span> Adding prd/ folder to git index
<span class="k">echo</span>.
git add --force prd/

<span class="c1">REM Commit that addition</span>
<span class="k">echo</span>.
<span class="k">echo</span> Committing changes
<span class="k">echo</span>.
git commit -m <span class="s2">&quot;Automated deployment of prd&quot;</span>

<span class="c1">REM Push this commit to remote repository</span>
<span class="k">echo</span>.
<span class="k">echo</span> Pushing to remote repository
<span class="k">echo</span>.
git push origin master
git status
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="automating-these-steps">
<h2>Automating these steps<a class="headerlink" href="#automating-these-steps" title="Permalink to this headline">¶</a></h2>
<p>Build and Deploy steps have been automated into 2 small <cite>.bat</cite> files, that are
stored directly in the root folder of this project.</p>
<p>It is possible to run these steps by simply calling <cite>Build</cite> or <cite>Deploy</cite> from
a command line.</p>
<p>Example of <cite>Build</cite> command output:</p>
<a class="reference internal image-reference" href="_images/Build.bat.PNG"><img alt="a command prompt showing the result of Build command" class="align-center" src="_images/Build.bat.PNG" style="width: 100.0%; height: 296.0px;" /></a>
<p>Example of <cite>Deploy</cite> command output:</p>
<a class="reference internal image-reference" href="_images/Deploy.bat.PNG"><img alt="a command prompt showing the result of Deploy command" class="align-center" src="_images/Deploy.bat.PNG" style="width: 100.0%; height: 410.0px;" /></a>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="apidoc-build/solver.scoring_funcs.html" class="btn btn-neutral float-left" title="scoring_funcs module documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Pierre Massé

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>